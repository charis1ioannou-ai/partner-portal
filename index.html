<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShipSat to Zwana Migration Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        header .subtitle {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .drop-zone-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .drop-zone-text {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .drop-zone-hint {
            font-size: 0.85rem;
            color: #718096;
        }

        #file-input {
            display: none;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .metric-card.total::before { background: #4a5568; }
        .metric-card.completed::before { background: #48bb78; }
        .metric-card.transit::before { background: #4299e1; }
        .metric-card.scheduled::before { background: #9f7aea; }
        .metric-card.discussion::before { background: #ed8936; }
        .metric-card.pending::before { background: #ecc94b; }
        .metric-card.blocked::before { background: #f56565; }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 4px;
        }

        .metric-percent {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
        }

        tr:hover {
            background: #f7fafc;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-completed { background: #c6f6d5; color: #22543d; }
        .status-transit { background: #bee3f8; color: #2a4365; }
        .status-scheduled { background: #e9d8fd; color: #553c9a; }
        .status-discussion { background: #feebc8; color: #744210; }
        .status-pending { background: #fefcbf; color: #744210; }
        .status-blocked { background: #fed7d7; color: #742a2a; }
        .status-notstarted { background: #e2e8f0; color: #4a5568; }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            transition: width 0.5s ease;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 0.75rem;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 180px;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        /* History */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .change-positive {
            color: #22543d;
            font-weight: 600;
        }

        .change-negative {
            color: #742a2a;
            font-weight: 600;
        }

        /* Hidden state */
        .hidden {
            display: none !important;
        }

        /* Fleet summary */
        .fleet-progress {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fleet-progress-text {
            font-size: 0.85rem;
            color: #718096;
            white-space: nowrap;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters {
                flex-direction: column;
            }

            .filter-group select, .filter-group input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ShipSat to Zwana Migration Dashboard</h1>
            <div class="subtitle" id="report-date">Upload an Excel file to begin</div>
        </header>

        <!-- Drop Zone -->
        <div class="card" id="upload-section">
            <div class="drop-zone" id="drop-zone">
                <div class="drop-zone-icon">ðŸ“Š</div>
                <div class="drop-zone-text">Drop Excel file here or click to browse</div>
                <div class="drop-zone-hint">Expected columns: No., Fleet, CAM, TAM, Vessel, Connectivity, Comments from CAM</div>
                <input type="file" id="file-input" accept=".xlsx,.xls">
            </div>
        </div>

        <!-- Dashboard Content (hidden until file loaded) -->
        <div id="dashboard-content" class="hidden">
            <!-- Metrics -->
            <div class="metrics-grid" id="metrics-grid">
                <div class="metric-card total">
                    <div class="metric-value" id="metric-total">0</div>
                    <div class="metric-label">Total Vessels</div>
                    <div class="metric-percent">100%</div>
                </div>
                <div class="metric-card completed">
                    <div class="metric-value" id="metric-completed">0</div>
                    <div class="metric-label">Completed</div>
                    <div class="metric-percent" id="percent-completed">0%</div>
                </div>
                <div class="metric-card transit">
                    <div class="metric-value" id="metric-transit">0</div>
                    <div class="metric-label">In Transit</div>
                    <div class="metric-percent" id="percent-transit">0%</div>
                </div>
                <div class="metric-card scheduled">
                    <div class="metric-value" id="metric-scheduled">0</div>
                    <div class="metric-label">Scheduled</div>
                    <div class="metric-percent" id="percent-scheduled">0%</div>
                </div>
                <div class="metric-card discussion">
                    <div class="metric-value" id="metric-discussion">0</div>
                    <div class="metric-label">In Discussion</div>
                    <div class="metric-percent" id="percent-discussion">0%</div>
                </div>
                <div class="metric-card pending">
                    <div class="metric-value" id="metric-pending">0</div>
                    <div class="metric-label">Pending Action</div>
                    <div class="metric-percent" id="percent-pending">0%</div>
                </div>
                <div class="metric-card blocked">
                    <div class="metric-value" id="metric-blocked">0</div>
                    <div class="metric-label">Blocked/Lost</div>
                    <div class="metric-percent" id="percent-blocked">0%</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-title">ðŸ“ˆ Migration Pipeline by Status</div>
                    <div class="chart-container">
                        <canvas id="pipeline-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">ðŸ›°ï¸ Vessels by Connectivity</div>
                    <div class="chart-container">
                        <canvas id="connectivity-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div class="card">
                <div class="history-header">
                    <div class="card-title">ðŸ“… Week-over-Week History</div>
                    <button class="btn btn-danger" id="clear-history-btn">Clear History</button>
                </div>
                <div class="table-wrapper">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Total</th>
                                <th>Completed</th>
                                <th>Change</th>
                                <th>In Transit</th>
                                <th>Scheduled</th>
                                <th>In Discussion</th>
                                <th>Pending</th>
                                <th>Blocked/Lost</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Fleet Summary -->
            <div class="card">
                <div class="card-title">ðŸš¢ Fleet Summary</div>
                <div class="table-wrapper">
                    <table id="fleet-table">
                        <thead>
                            <tr>
                                <th>Fleet</th>
                                <th>Total</th>
                                <th>Completed</th>
                                <th>In Transit</th>
                                <th>Scheduled</th>
                                <th>In Discussion</th>
                                <th>Pending</th>
                                <th>Blocked</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="fleet-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Vessel Details -->
            <div class="card">
                <div class="card-title">ðŸ“‹ Vessel Details</div>
                <div class="filters">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filter-status">
                            <option value="">All Statuses</option>
                            <option value="Completed">Completed</option>
                            <option value="In Transit">In Transit</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="In Discussion">In Discussion</option>
                            <option value="Pending Action">Pending Action</option>
                            <option value="Blocked/Lost">Blocked/Lost</option>
                            <option value="Not Started">Not Started</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>CAM</label>
                        <select id="filter-cam">
                            <option value="">All CAMs</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="filter-search" placeholder="Search vessels...">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="vessel-table">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Fleet</th>
                                <th>CAM</th>
                                <th>TAM</th>
                                <th>Vessel</th>
                                <th>Connectivity</th>
                                <th>Status</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody id="vessel-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Storage key
        const HISTORY_KEY = 'shipsat_migration_history';
        const MAX_HISTORY_WEEKS = 52;

        // Global data
        let vesselData = [];
        let statusCounts = {};
        let connectivityCounts = {};
        let fleetSummary = {};
        let pipelineChart = null;
        let connectivityChart = null;

        // Status classification rules
        function classifyStatus(comment) {
            if (!comment || typeof comment !== 'string') {
                return 'Not Started';
            }
            
            const text = comment.toLowerCase().trim();
            
            if (!text) {
                return 'Not Started';
            }

            // Completed
            if (text.includes('completed') || text.includes('already migrated')) {
                return 'Completed';
            }

            // In Transit
            if (text.includes('in transit') || text.includes('zwana is delivered') || text.includes('expecting their signatures')) {
                return 'In Transit';
            }

            // Blocked/Lost
            if (text.includes('declined') || text.includes('owner changed the provider') || 
                text.includes('ofac') || text.includes('detention') || text.includes('penalty clause')) {
                return 'Blocked/Lost';
            }

            // Scheduled
            if (text.includes('migration is planned') || text.includes('migration planned')) {
                return 'Scheduled';
            }

            // In Discussion
            if (text.includes('in progress') || text.includes('in discussion') || 
                text.includes('under discussion') || text.includes('in touch') || 
                text.includes('evaluating') || text.includes('proposed') || text.includes('considering')) {
                return 'In Discussion';
            }

            // Pending Action
            if (text.includes('followed up') || text.includes('notice sent') || 
                text.includes('reaching out') || text.includes('left management') || text.includes('sold soon')) {
                return 'Pending Action';
            }

            // Default
            return 'In Discussion';
        }

        // Extract date from filename (pattern: DD-M-YYYY)
        function extractDateFromFilename(filename) {
            const match = filename.match(/(\d{1,2})-(\d{1,2})-(\d{4})/);
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = match[2].padStart(2, '0');
                const year = match[3];
                return `${year}-${month}-${day}`;
            }
            return new Date().toISOString().split('T')[0];
        }

        // Get week key from date
        function getWeekKey(dateStr) {
            const date = new Date(dateStr);
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
            const weekNum = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            return `${date.getFullYear()}-W${weekNum.toString().padStart(2, '0')}`;
        }

        // Format date for display
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Get status badge class
        function getStatusBadgeClass(status) {
            const classes = {
                'Completed': 'status-completed',
                'In Transit': 'status-transit',
                'Scheduled': 'status-scheduled',
                'In Discussion': 'status-discussion',
                'Pending Action': 'status-pending',
                'Blocked/Lost': 'status-blocked',
                'Not Started': 'status-notstarted'
            };
            return classes[status] || 'status-notstarted';
        }

        // Process Excel data
        function processExcelData(data, filename) {
            vesselData = [];
            statusCounts = {
                'Completed': 0,
                'In Transit': 0,
                'Scheduled': 0,
                'In Discussion': 0,
                'Pending Action': 0,
                'Blocked/Lost': 0,
                'Not Started': 0
            };
            connectivityCounts = {};
            fleetSummary = {};

            // Find header row (look for "No." or similar)
            let headerRowIndex = 0;
            for (let i = 0; i < Math.min(10, data.length); i++) {
                const row = data[i];
                if (row && (row['No.'] !== undefined || row['No'] !== undefined || 
                    Object.values(row).some(v => typeof v === 'string' && v.toLowerCase().includes('vessel')))) {
                    headerRowIndex = i;
                    break;
                }
            }

            // Process each row
            data.forEach((row, index) => {
                if (!row) return;

                // Try to extract data with flexible column names
                const no = row['No.'] || row['No'] || row['#'] || '';
                const fleet = row['Fleet'] || '';
                const cam = row['Commercial Account Manager (CAM)'] || row['CAM'] || row['Commercial Account Manager'] || '';
                const tam = row['Technical Account Manager (TAM)'] || row['TAM'] || row['Technical Account Manager'] || '';
                const vessel = row['Vessel'] || row['Vessel Name'] || '';
                const connectivity = row['Connectivity'] || row['Connectivity Type'] || '';
                const comments = row['Comments from CAM'] || row['Comments'] || row['CAM Comments'] || '';

                // Skip empty rows or header rows
                if (!vessel && !fleet && !no) return;
                if (typeof vessel === 'string' && vessel.toLowerCase() === 'vessel') return;

                const status = classifyStatus(comments);

                const vesselRecord = {
                    no: no,
                    fleet: fleet,
                    cam: cam,
                    tam: tam,
                    vessel: vessel,
                    connectivity: connectivity,
                    comments: comments,
                    status: status
                };

                vesselData.push(vesselRecord);

                // Count statuses
                statusCounts[status] = (statusCounts[status] || 0) + 1;

                // Count connectivity types
                const connType = connectivity || 'Unknown';
                connectivityCounts[connType] = (connectivityCounts[connType] || 0) + 1;

                // Fleet summary
                const fleetName = fleet || 'Unknown';
                if (!fleetSummary[fleetName]) {
                    fleetSummary[fleetName] = {
                        total: 0,
                        'Completed': 0,
                        'In Transit': 0,
                        'Scheduled': 0,
                        'In Discussion': 0,
                        'Pending Action': 0,
                        'Blocked/Lost': 0,
                        'Not Started': 0
                    };
                }
                fleetSummary[fleetName].total++;
                fleetSummary[fleetName][status]++;
            });

            // Extract date and update header
            const reportDate = extractDateFromFilename(filename);
            document.getElementById('report-date').textContent = `Report Date: ${formatDate(reportDate)}`;

            // Save to history
            saveToHistory(reportDate, statusCounts, vesselData.length);

            // Update dashboard
            updateDashboard();
        }

        // Save to localStorage history
        function saveToHistory(dateStr, counts, total) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const weekKey = getWeekKey(dateStr);

            // Find or create entry for this week
            const existingIndex = history.findIndex(h => h.weekKey === weekKey);
            const entry = {
                weekKey: weekKey,
                date: dateStr,
                total: total,
                completed: counts['Completed'] || 0,
                transit: counts['In Transit'] || 0,
                scheduled: counts['Scheduled'] || 0,
                discussion: counts['In Discussion'] || 0,
                pending: counts['Pending Action'] || 0,
                blocked: counts['Blocked/Lost'] || 0
            };

            if (existingIndex >= 0) {
                history[existingIndex] = entry;
            } else {
                history.push(entry);
            }

            // Sort by week key descending
            history.sort((a, b) => b.weekKey.localeCompare(a.weekKey));

            // Keep only last 52 weeks
            history = history.slice(0, MAX_HISTORY_WEEKS);

            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        // Update dashboard
        function updateDashboard() {
            const total = vesselData.length;

            // Update metrics
            document.getElementById('metric-total').textContent = total;
            document.getElementById('metric-completed').textContent = statusCounts['Completed'] || 0;
            document.getElementById('metric-transit').textContent = statusCounts['In Transit'] || 0;
            document.getElementById('metric-scheduled').textContent = statusCounts['Scheduled'] || 0;
            document.getElementById('metric-discussion').textContent = statusCounts['In Discussion'] || 0;
            document.getElementById('metric-pending').textContent = statusCounts['Pending Action'] || 0;
            document.getElementById('metric-blocked').textContent = statusCounts['Blocked/Lost'] || 0;

            // Update percentages
            const pct = (val) => total > 0 ? ((val / total) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('percent-completed').textContent = pct(statusCounts['Completed'] || 0);
            document.getElementById('percent-transit').textContent = pct(statusCounts['In Transit'] || 0);
            document.getElementById('percent-scheduled').textContent = pct(statusCounts['Scheduled'] || 0);
            document.getElementById('percent-discussion').textContent = pct(statusCounts['In Discussion'] || 0);
            document.getElementById('percent-pending').textContent = pct(statusCounts['Pending Action'] || 0);
            document.getElementById('percent-blocked').textContent = pct(statusCounts['Blocked/Lost'] || 0);

            // Update charts
            updateCharts();

            // Update tables
            updateHistoryTable();
            updateFleetTable();
            updateVesselTable();
            populateCAMFilter();

            // Show dashboard
            document.getElementById('dashboard-content').classList.remove('hidden');
        }

        // Update charts
        function updateCharts() {
            const statusLabels = ['Completed', 'In Transit', 'Scheduled', 'In Discussion', 'Pending Action', 'Blocked/Lost', 'Not Started'];
            const statusColors = ['#48bb78', '#4299e1', '#9f7aea', '#ed8936', '#ecc94b', '#f56565', '#a0aec0'];
            const statusData = statusLabels.map(s => statusCounts[s] || 0);

            // Pipeline Chart (horizontal bar)
            const pipelineCtx = document.getElementById('pipeline-chart').getContext('2d');
            if (pipelineChart) pipelineChart.destroy();
            pipelineChart = new Chart(pipelineCtx, {
                type: 'bar',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        label: 'Vessels',
                        data: statusData,
                        backgroundColor: statusColors,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: '#e2e8f0' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Connectivity Chart (doughnut)
            const connLabels = Object.keys(connectivityCounts);
            const connData = Object.values(connectivityCounts);
            const connColors = ['#4299e1', '#48bb78', '#ed8936', '#9f7aea', '#f56565', '#ecc94b', '#38b2ac', '#667eea'];

            const connectivityCtx = document.getElementById('connectivity-chart').getContext('2d');
            if (connectivityChart) connectivityChart.destroy();
            connectivityChart = new Chart(connectivityCtx, {
                type: 'doughnut',
                data: {
                    labels: connLabels,
                    datasets: [{
                        data: connData,
                        backgroundColor: connColors.slice(0, connLabels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, padding: 12 }
                        }
                    }
                }
            });
        }

        // Update history table
        function updateHistoryTable() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';

            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#718096;">No history data yet</td></tr>';
                return;
            }

            history.forEach((entry, index) => {
                const prevEntry = history[index + 1];
                let changeHtml = '-';
                if (prevEntry) {
                    const change = entry.completed - prevEntry.completed;
                    if (change > 0) {
                        changeHtml = `<span class="change-positive">+${change}</span>`;
                    } else if (change < 0) {
                        changeHtml = `<span class="change-negative">${change}</span>`;
                    } else {
                        changeHtml = '0';
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.weekKey}<br><small style="color:#718096;">${formatDate(entry.date)}</small></td>
                    <td>${entry.total}</td>
                    <td>${entry.completed}</td>
                    <td>${changeHtml}</td>
                    <td>${entry.transit}</td>
                    <td>${entry.scheduled}</td>
                    <td>${entry.discussion}</td>
                    <td>${entry.pending}</td>
                    <td>${entry.blocked}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update fleet table
        function updateFleetTable() {
            const tbody = document.getElementById('fleet-body');
            tbody.innerHTML = '';

            const fleets = Object.entries(fleetSummary).sort((a, b) => b[1].total - a[1].total);

            fleets.forEach(([fleetName, data]) => {
                const completedPct = data.total > 0 ? ((data['Completed'] / data.total) * 100).toFixed(0) : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${fleetName}</strong></td>
                    <td>${data.total}</td>
                    <td><span class="status-badge status-completed">${data['Completed']}</span></td>
                    <td><span class="status-badge status-transit">${data['In Transit']}</span></td>
                    <td><span class="status-badge status-scheduled">${data['Scheduled']}</span></td>
                    <td><span class="status-badge status-discussion">${data['In Discussion']}</span></td>
                    <td><span class="status-badge status-pending">${data['Pending Action']}</span></td>
                    <td><span class="status-badge status-blocked">${data['Blocked/Lost']}</span></td>
                    <td>
                        <div class="fleet-progress">
                            <div class="progress-bar" style="width:100px;">
                                <div class="progress-fill" style="width:${completedPct}%;"></div>
                            </div>
                            <span class="fleet-progress-text">${completedPct}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Populate CAM filter
        function populateCAMFilter() {
            const camSelect = document.getElementById('filter-cam');
            const cams = [...new Set(vesselData.map(v => v.cam).filter(c => c))].sort();
            
            camSelect.innerHTML = '<option value="">All CAMs</option>';
            cams.forEach(cam => {
                const option = document.createElement('option');
                option.value = cam;
                option.textContent = cam;
                camSelect.appendChild(option);
            });
        }

        // Update vessel table
        function updateVesselTable() {
            const tbody = document.getElementById('vessel-body');
            const statusFilter = document.getElementById('filter-status').value;
            const camFilter = document.getElementById('filter-cam').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();

            tbody.innerHTML = '';

            const filtered = vesselData.filter(v => {
                if (statusFilter && v.status !== statusFilter) return false;
                if (camFilter && v.cam !== camFilter) return false;
                if (searchFilter) {
                    const searchStr = `${v.vessel} ${v.fleet} ${v.cam} ${v.tam} ${v.comments}`.toLowerCase();
                    if (!searchStr.includes(searchFilter)) return false;
                }
                return true;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#718096;">No vessels match the filters</td></tr>';
                return;
            }

            filtered.forEach(v => {
                const row = document.createElement('tr');
                const commentsPreview = v.comments.length > 100 ? v.comments.substring(0, 100) + '...' : v.comments;
                row.innerHTML = `
                    <td>${v.no}</td>
                    <td>${v.fleet}</td>
                    <td>${v.cam}</td>
                    <td>${v.tam}</td>
                    <td><strong>${v.vessel}</strong></td>
                    <td>${v.connectivity}</td>
                    <td><span class="status-badge ${getStatusBadgeClass(v.status)}">${v.status}</span></td>
                    <td title="${v.comments.replace(/"/g, '&quot;')}">${commentsPreview}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // File handling
        function handleFile(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                    processExcelData(jsonData, file.name);
                } catch (error) {
                    console.error('Error processing file:', error);
                    alert('Error processing Excel file. Please ensure it is a valid Excel file with the expected columns.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            // Click to browse
            dropZone.addEventListener('click', () => fileInput.click());

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            // Filter events
            document.getElementById('filter-status').addEventListener('change', updateVesselTable);
            document.getElementById('filter-cam').addEventListener('change', updateVesselTable);
            document.getElementById('filter-search').addEventListener('input', updateVesselTable);

            // Clear history
            document.getElementById('clear-history-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all history data?')) {
                    localStorage.removeItem(HISTORY_KEY);
                    updateHistoryTable();
                }
            });

            // Load existing history on page load
            updateHistoryTable();
        });
    </script>
</body>
</html>
